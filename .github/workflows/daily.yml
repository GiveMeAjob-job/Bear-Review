# .github/workflows/daily.yml - æœ€ç»ˆç‰ˆï¼šæ¯æ—¥è‡ªåŠ¨ç”Ÿæˆæ—¥æŠ¥ + ä¸‰æ—¥æŠ¥å‘Š

name: Daily & Trend Reports

on:
  schedule:
    # æ¯å¤©åœ¨æ‚¨é€‰æ‹©çš„å›ºå®šæ—¶é—´è‡ªåŠ¨è¿è¡Œ
    - cron: '0 4 * * *'  # UTC æ—¶é—´ï¼Œå¯è‡ªè¡Œè°ƒæ•´
  workflow_dispatch:
    inputs:
      report_type:
        description: 'æŠ¥å‘Šç±»å‹ (ä»…æ‰‹åŠ¨è§¦å‘æ—¶æœ‰æ•ˆ)'
        type: choice
        default: 'yesterday'
        options:
          - 'yesterday'
          - 'three-days'
          - 'today'
      dry_run:
        description: 'è¯•è¿è¡Œï¼ˆä¸å‘é€é€šçŸ¥ï¼‰'
        type: boolean
        default: false
      verbose:
        description: 'è¯¦ç»†æ—¥å¿—'
        type: boolean
        default: false

jobs:
  daily-review:
    runs-on: ubuntu-latest
    timeout-minutes: 20 # è¿è¡Œä¸¤ä¸ªæŠ¥å‘Šï¼Œå¯ä»¥é€‚å½“å»¶é•¿è¶…æ—¶

    steps:
      # 1ï¸âƒ£ & 2ï¸âƒ£ & 3ï¸âƒ£: Checkout, Setup Python, Install dependencies (ä¸å˜)
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
      - run: pip install -r requirements.txt

      # 4ï¸âƒ£: Debug env (ä¸å˜)
      - name: Debug env
        if: github.event.inputs.verbose == 'true'
        run: |
          echo "NOTION_DB_ID=$NOTION_DB_ID"
          echo "TOK_LEN=${#NOTION_TOKEN}"

      # 5ï¸âƒ£: æ‰§è¡Œè„šæœ¬ (æ ¸å¿ƒä¿®æ”¹)
      - name: Run Reports
        env:
          # --- æ‰€æœ‰ç¯å¢ƒå˜é‡ä¸å˜ ---
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
          DEEPSEEK_KEY: ${{ secrets.DEEPSEEK_KEY }}
          OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
          LLM_PROVIDER: ${{ secrets.LLM_PROVIDER }}
          LLM_MODEL: deepseek-chat
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_BOT_TOKEN_2: ${{ secrets.TELEGRAM_BOT_TOKEN_2 }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_CHAT_ID_2: ${{ secrets.TELEGRAM_CHAT_ID_2 }}
          EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER }}
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          TIMEZONE: ${{ secrets.TIMEZONE }}
        run: |
          # --- âœ… æ ¸å¿ƒä¿®æ”¹é€»è¾‘ ---
          # åˆ¤æ–­å½“å‰å·¥ä½œæµæ˜¯ç”± 'schedule' (å®šæ—¶) è¿˜æ˜¯ 'workflow_dispatch' (æ‰‹åŠ¨) è§¦å‘çš„
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # --- å¦‚æœæ˜¯å®šæ—¶è‡ªåŠ¨è§¦å‘ ---
            echo "â° å®šæ—¶ä»»åŠ¡è§¦å‘ï¼Œå°†ç”Ÿæˆæ—¥æŠ¥å’Œä¸‰æ—¥æŠ¥å‘Š..."
            
            echo -e "\n--- (1/2) ç”Ÿæˆæ˜¨å¤©çš„æ—¥æŠ¥ ---"
            python -m src.main --period daily --yesterday --verbose
            
            echo -e "\n--- (2/2) ç”Ÿæˆä¸‰æ—¥è¶‹åŠ¿åˆ†æ ---"
            python -m src.main --period three-days --verbose

          else
            # --- å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ ---
            echo "ğŸ‘¨â€ğŸ’» æ‰‹åŠ¨è§¦å‘ï¼Œå°†æ ¹æ®è¾“å…¥ç”ŸæˆæŒ‡å®šæŠ¥å‘Š..."
            REPORT_TYPE="${{ github.event.inputs.report_type }}"
            echo "ğŸ“Š æŠ¥å‘Šç±»å‹: $REPORT_TYPE"
            
            # ä½¿ç”¨æ‚¨åŸæ¥çš„ case è¯­å¥ï¼Œé€»è¾‘å®Œå…¨ä¸å˜
            case "$REPORT_TYPE" in
              "three-days")
                python -m src.main --period three-days ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }} ${{ github.event.inputs.verbose == 'true' && '--verbose' || '' }}
                ;;
              "yesterday")
                python -m src.main --period daily --yesterday ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }} ${{ github.event.inputs.verbose == 'true' && '--verbose' || '' }}
                ;;
              "today")
                python -m src.main --period daily ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }} ${{ github.event.inputs.verbose == 'true' && '--verbose' || '' }}
                ;;
              *)
                echo "âŒ æœªçŸ¥çš„æŠ¥å‘Šç±»å‹: $REPORT_TYPE"
                exit 1
                ;;
            esac
          fi